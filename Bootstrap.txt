# ğŸ® AI DUNGEON MASTER â€” MASTER BOOTSTRAP DOCUMENT
> **Last Updated:** February 2026 | **Status:** âœ… Fully Deployed & Operational  
> **Purpose:** Complete handoff document â€” paste this at the start of every new AI session

---

## ğŸ”— LIVE DEPLOYMENT URLS

| Service | URL | Platform |
|---|---|---|
| **Frontend** | https://ai-dungeon-master-sepia.vercel.app | Vercel |
| **Backend** | https://ai-dungeon-master-production-91c0.up.railway.app | Railway |
| **Repository** | GitHub â€” `AI-Dungeon-Master` (main branch) | GitHub |

---

## ğŸ”‘ ENVIRONMENT VARIABLES (CRITICAL â€” KEEP UPDATED)

### Railway (Backend)
```env
GROQ_API_KEY=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
ELEVENLABS_API_KEY=sk_8b508aa9cf4346db31a259ad9bc5bce9dfe18f0b9342f223
PORT=3001
```

### Vercel (Frontend)
```env
REACT_APP_API_URL=https://ai-dungeon-master-production-91c0.up.railway.app
```

> âš ï¸ **GROQ API KEYS EXPIRE PERIODICALLY.** If the AI stops responding, get a fresh key from https://console.groq.com and update it in Railway dashboard â†’ Variables.

---

## ğŸ—ï¸ COMPLETE TECH STACK

### Backend â€” Railway (Node.js)
| Component | Detail |
|---|---|
| Runtime | Node.js 18+ |
| Framework | Express.js v5.2.1 |
| AI Model | Groq API â†’ Llama 3.3 70B |
| Voice Synthesis | ElevenLabs (`eleven_turbo_v2_5`) |
| Sound Effects | ElevenLabs ambient sounds |
| Port | 3001 |

### Frontend â€” Vercel (React)
| Component | Detail |
|---|---|
| Framework | React 18 (Create React App) |
| State Management | Zustand |
| Routing | React Router |
| HTTP Client | Axios |
| Styling | Custom CSS (dark fantasy theme â€” gold accents, dark backgrounds) |

---

## ğŸ“ COMPLETE FILE MAP

### Backend Files
```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ dm/
â”‚   â”‚   â””â”€â”€ dmEngine.js          â­ Groq AI prompt builder â€” CORE AI LOGIC
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ voice.js             â­ ElevenLabs voice â€” MUST use eleven_turbo_v2_5
```

### Frontend Files
```
frontend/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ GameScreen.jsx           â­ MAIN GAME UI â€” ALL systems integrated here
â”‚   â”œâ”€â”€ CombatTracker.jsx        â­ Turn-based combat, initiative, status effects
â”‚   â”œâ”€â”€ CharacterSheet.jsx       â­ Full character display, Combat tab fixed
â”‚   â”œâ”€â”€ SpellBook.jsx            â­ Spell management UI
â”‚   â”œâ”€â”€ StatusEffectsPanel.jsx   âœ… NEW â€” Display (full & compact views)
â”‚   â””â”€â”€ ApplyStatusEffectModal.jsx âœ… NEW â€” Manual status effect application UI
â”œâ”€â”€ state/
â”‚   â””â”€â”€ campaignStore.js         â­ Zustand store â€” central state
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ combatSystem.js          â­ 50+ enemies, damage calculation
â”‚   â”œâ”€â”€ spellSystem.js           â­ 50+ spells, spell slots, spell logic
â”‚   â”œâ”€â”€ statusEffectSystem.js    âœ… NEW â€” 20+ D&D 5e conditions, core logic
â”‚   â”œâ”€â”€ xpSystem.js              â­ XP auto-detection from narration
â”‚   â”œâ”€â”€ inventorySystem.js       â­ Loot auto-detection, weight
â”‚   â””â”€â”€ questSystem.js           â­ Quest auto-detection from narration
```

---

## âœ… COMPLETE FEATURE LIST â€” ALL WORKING

### Core Systems
1. **Campaign Management** â€” Theme/difficulty selection, party setup wizard
2. **Character System** â€” Full D&D 5e: 12 classes, 9 races, point-buy stats
3. **Combat System** â€” Turn-based, initiative order, AI enemy turns, 50+ enemy types
4. **XP & Leveling** â€” Auto-detection from narration, levels 1â€“20, epic level-up animations
5. **Inventory System** â€” Equipment slots, potions, auto-loot detection, weight tracking
6. **Quest Tracker** â€” Auto-detection, active/completed/failed states
7. **Spell System** â€” 50+ spells (Cantripâ€“Level 9), slot tracking, prepared/known distinction
8. **Bestiary** â€” 50+ enemies across 10 categories, encounter history tracking
9. **Save/Load** â€” Multiple named slots, auto-save, JSON export/import
10. **Dice Rolling** â€” d4 through d20, 30-second DM integration window
11. **Voice Narration** â€” ElevenLabs, 5 distinct character voices
12. **Background Music** â€” 10 tracks, auto scene-change detection
13. **Sound Effects** â€” ElevenLabs ambient soundscape
14. **Status Effects** â­ RECENTLY COMPLETED â€” Full D&D 5e conditions system (see below)

### Character Classes (All 12 D&D 5e Core)
Barbarian, Bard, Cleric, Druid, Fighter, Monk, Paladin, Ranger, Rogue, Sorcerer, Warlock, Wizard

### Character Races (9)
Human, Elf, Dwarf, Halfling, Half-Elf, Half-Orc, Gnome, Tiefling, Dragonborn

### Spells (50+)
- Cantrips through Level 9
- Spell slot tracking per class table
- Prepared/known spell distinction
- SpellBook UI for casting outside combat
- âŒ NOT YET: Spell damage application in combat
- âŒ NOT YET: Target selection for offensive spells

### Enemies (50+, 10 Categories)
CR range: 0.125 to CR 10 â€” covers full tier 1 and tier 2 play

### Status Effects (20+ D&D 5e Conditions) âœ… FULLY IMPLEMENTED
**Standard Conditions:** Blinded, Charmed, Deafened, Exhaustion (1â€“6), Frightened, Grappled, Incapacitated, Invisible, Paralyzed, Petrified, Poisoned, Prone, Restrained, Stunned, Unconscious  
**Spell Effects:** Blessed, Hasted, Slowed, Concentrating  
**Combat Effects:** Raging, Dodging, Burning, Bleeding

---

## ğŸ”„ AUTO-DETECTION SYSTEMS

All four systems parse the DM's narration text and automatically update game state:

### Pattern (Same for all)
```javascript
// Detect events in narration â†’ Update state â†’ Show notification
const events = detectXFromNarration(dmResponse.aiResponse);
if (events.length > 0) {
  updateState(events);
  showNotification(events);
}
```

### XP Detection (`xpSystem.js`)
- Parses narration for XP grant phrases
- Triggers level-up animation if threshold crossed
- Handles milestone XP and combat XP

### Loot Detection (`inventorySystem.js`)
- Detects item drops and gold awards from narration
- Auto-adds to character inventory
- Weight calculation

### Quest Detection (`questSystem.js`)
- Detects new quest starts, completions, and failures
- Updates quest tracker UI

### Status Effect Detection (`statusEffectSystem.js`)
Currently detecting these keywords in narration:
`poisoned, paralyzed, stunned, frightened, charmed, blinded, prone, restrained, unconscious, burning, bleeding, blessed, hasted, slowed`

---

## âš”ï¸ COMBAT SYSTEM â€” FULL FLOW

### Turn Order
1. Roll initiative (d20 + DEX modifier) for all combatants
2. Sort by initiative (ties broken by DEX score)
3. Player turns â†’ AI-controlled enemy turns â†’ repeat

### Combat Turn Processing with Status Effects
```javascript
// 1. Turn starts â†’ Process status effects (damage, duration countdown)
const statusResult = processStatusEffectsOnTurnStart(combatant);

// 2. Check if can act (incapacitated/stunned/paralyzed blocks action)
if (canAct) {
  // 3. Calculate advantage/disadvantage from active effects
  const { hasAdvantage, hasDisadvantage } = getAdvantageStatus(effects);
  
  // 4. Execute action (attack, spell, item use, etc.)
  executeAttack(target, hasAdvantage, hasDisadvantage);
}

// 5. If damaged, check concentration (DC 10 or half damage taken, whichever higher)
if (damageTaken && isConcentrating) {
  checkConcentration(damageTaken);
}

// 6. End turn â€” tick durations, remove expired effects
handleEndTurn();
```

### Status Effect Application
```javascript
const effect = createStatusEffect({ type, duration, durationType });
// durationType options: 'rounds' | 'minutes' | 'save-ends' | 'concentration'
const updatedChar = applyStatusEffect(character, effect);
updateParty(updatedParty);
```

### AI Enemy Turns
- Fully automated by DM engine
- Enemy selects targets, rolls attacks, applies damage
- Enemy uses abilities based on bestiary entry

---

## ğŸ­ STATUS EFFECTS SYSTEM â€” DEEP DIVE (RECENTLY COMPLETED)

### Files
| File | Purpose |
|---|---|
| `frontend/src/utils/statusEffectSystem.js` | Core logic, creation, application, processing |
| `frontend/src/components/StatusEffectsPanel.jsx` | Display (full view + compact icon strip) |
| `frontend/src/components/ApplyStatusEffectModal.jsx` | Manual application UI modal |

### Features
- âœ… Auto-detection from DM narration
- âœ… Manual application via "ğŸ­ Effects" button in GameScreen
- âœ… Advantage/disadvantage calculation (e.g., Blinded = disadvantage on attacks)
- âœ… Incapacitation enforcement (Stunned/Paralyzed = skip turn)
- âœ… Concentration checks on damage (DC = max(10, half damage))
- âœ… Damage-over-time (Burning 1d6/turn, Bleeding 1d4/turn)
- âœ… Duration tracking (rounds, minutes, save-ends, concentration)
- âœ… Exhaustion levels 1â€“6 with stacking penalties
- âœ… Visual icons on character cards in party view
- âœ… Badge counters showing active effect count

### Integration Points
- **GameScreen.jsx** â€” Auto-detection hook, ğŸ­ Effects button, visual badges
- **CombatTracker.jsx** â€” Turn processing, advantage calc, concentration checks
- **CharacterSheet.jsx** â€” Combat tab renders `condition.name` (not condition object â€” critical fix!)

---

## ğŸ› KNOWN BUGS & FIXES â€” COMPLETE HISTORY

### Bug 1: Status Effect Rendering Error âœ… FIXED
**Symptom:** "Objects are not valid as a React child" error  
**Root Cause:** Rendering `condition` (object) instead of `condition.name` (string)  
**Fix Location:** `frontend/src/components/CharacterSheet.jsx` â†’ CombatTab section  
**Fix:** Change `{condition}` to `{condition.name}` everywhere conditions are mapped

### Bug 2: Groq API Key Expiry âš ï¸ ONGOING
**Symptom:** AI DM stops responding, 401 errors in Railway logs  
**Fix:** Get new key at https://console.groq.com â†’ Update Railway env var `GROQ_API_KEY`  
**Note:** Keys expire without warning â€” first thing to check if AI goes silent

### Bug 3: ElevenLabs Wrong Voice Model âœ… FIXED (permanent)
**Symptom:** Voice synthesis fails with model error  
**Root Cause:** Wrong model string used  
**Fix:** Always use `eleven_turbo_v2_5` â€” NEVER `eleven_monolingual_v1`  
**Location:** `backend/src/routes/voice.js`

### Bug 4: CORS Issues âœ… FIXED
**Symptom:** Frontend can't reach backend  
**Fix:** CORS configured in Express to allow Vercel domain  
**Location:** `backend/src/index.js` (or main entry)

### Bug 5: React State Management (Historical)
**Symptom:** State updates not reflecting in UI  
**Fix:** Zustand store properly structured; use shallow equality selectors where needed

---

## âŒ NOT YET IMPLEMENTED â€” PRIORITY ORDER

### 1. ğŸ¯ Spell Damage in Combat â€” RECOMMENDED NEXT
**What:** Cast offensive spells during combat, apply damage to enemies  
**Files to Modify:**
- `frontend/src/components/CombatTracker.jsx` â€” Add "Cast Spell" action option
- `frontend/src/utils/spellSystem.js` â€” Add `calculateSpellDamage()` function
- `frontend/src/components/SpellBook.jsx` â€” Add "Cast in Combat" button (only shows when in combat)
- `frontend/src/components/CombatTracker.jsx` â€” Add target selection UI

**Implementation Notes:**
- Spell attacks: roll d20 + spellcasting modifier vs target AC
- Saving throw spells: target rolls save vs spell save DC (8 + proficiency + casting mod)
- Damage on hit: roll spell damage dice (e.g., Fireball = 8d6 fire)
- Many spells apply status effects â€” integrate with statusEffectSystem
- Cantrips scale with character level (standard D&D 5e progression)
- Spell slots must be consumed on cast

### 2. Shop/Merchant System
- Buy/sell items with gold economy
- Price scaling by item rarity
- Merchant NPC auto-appears based on DM narration

### 3. Concentration Tracking Improvements
- Visual indicator (icon/glow) on spell that requires concentration
- Auto-break when Incapacitated or Unconscious condition applied
- Warning popup when trying to cast second concentration spell

### 4. Warlock Pact Magic
- All spell slots same level (not tiered)
- Recover ALL slots on short rest (not long rest)
- Special handling needed in spell slot tracker

### 5. Third-Caster Spell Support
- Eldritch Knight (Fighter archetype): 1/3 spell progression
- Arcane Trickster (Rogue archetype): 1/3 spell progression
- Spell list restricted to Wizard school (EK) / Enchantment+Illusion (AT)

### 6. Ritual Casting
- Cast certain spells without expending a slot
- Takes 10 minutes (skip in exploration, flag in combat)
- Show [R] tag on eligible spells in SpellBook

### 7. Patreon Monetization Integration
- Patreon OAuth for supporter verification
- Premium features gate (extra voices, more save slots, etc.)

---

## ğŸ¨ DESIGN SYSTEM

### Visual Theme
- **Background:** Deep dark (#0a0a0f, #111118)
- **Accent:** Gold (#c9a84c, #e8c76b)
- **Text:** Light parchment (#f0e6d3)
- **Danger:** Deep crimson (#8b1a1a)
- **Magic:** Purple (#6b21a8 range)

### UI Patterns
- Dark fantasy aesthetic throughout
- Gold borders on important panels
- Glowing effects on active elements (combat, spells)
- Parchment texture for character sheet
- Epic animations on level-up

---

## ğŸš€ HOW TO START A NEW DEVELOPMENT SESSION

### Step 1 â€” Orient the AI
Paste this entire document at the start of the chat.

### Step 2 â€” State Your Goal
Example: *"I want to implement Spell Damage in Combat (Priority 1 from the bootstrap)."*

### Step 3 â€” Request Full Files
Always ask for **complete file contents**, not snippets. The codebase is integrated enough that partial edits cause missed references.

### Step 4 â€” Test Checklist Before Deploying
```
â–¡ Status effects: Apply effect â†’ Start combat â†’ Verify turn processing
â–¡ Combat: Complete a full combat encounter
â–¡ Spells: Cast a spell from SpellBook
â–¡ Voice: Trigger narration â†’ Voice plays
â–¡ Save/Load: Save game â†’ Reload â†’ Load save
â–¡ Auto-detection: Get XP/loot/quest from narration
```

### Step 5 â€” Deploy
```bash
# Backend auto-deploys on git push to main
git add .
git commit -m "feat: description"
git push

# Frontend â€” manual redeploy
# Go to vercel.com â†’ ai-dungeon-master â†’ Deployments â†’ Redeploy
```

---

## ğŸ“Š SYSTEM METRICS

| Metric | Count |
|---|---|
| Spells | 50+ (Cantripâ€“Level 9) |
| Enemies | 50+ |
| Enemy Categories | 10 |
| Character Classes | 12 |
| Character Races | 9 |
| Music Tracks | 10 |
| Max Character Level | 20 |
| Status Effect Types | 20+ |
| Voice Options | 5 |
| Save Slots | Multiple (named) |

---

## ğŸ’¡ KEY ARCHITECTURAL DECISIONS

1. **All auto-detection happens in GameScreen.jsx** â€” it's the orchestration layer. Every DM response passes through it before state updates.

2. **Zustand store is single source of truth** â€” never hold important state in component local state if it needs to persist or be accessed elsewhere.

3. **Status effects live on character objects** â€” not in a separate store. Each character has `statusEffects: []` array.

4. **Combat state is separate from campaign state** â€” CombatTracker manages its own local combat state, syncing back to campaignStore only on combat end.

5. **All AI communication goes through dmEngine.js** â€” the prompt builder. If the AI behaves strangely, this is the first place to look.

6. **ElevenLabs calls are fire-and-forget** â€” voice plays asynchronously, doesn't block game state updates.

---

## ğŸ”’ SECURITY NOTES

- âš ï¸ API keys are in environment variables â€” **never hardcode in frontend files**
- âš ï¸ The repo is public (GitHub) â€” audit before pushing to ensure no keys leaked in code history
- Backend validates requests but does not currently enforce authentication â€” consider adding if the app scales

---

## ğŸ“ DEVELOPMENT PRINCIPLES (George's Preferences)

1. **Always provide complete file contents** â€” no partial snippets or "replace this section" instructions
2. **One major feature at a time** â€” fully implement and test before moving on
3. **Automated game mechanics preferred** â€” the app should detect and respond without manual player intervention wherever possible
4. **Full D&D 5e accuracy** â€” don't simplify mechanics, implement them properly
5. **Console.log debugging** â€” the codebase uses extensive console.logs; keep them in during development

---

## ğŸ†˜ QUICK TROUBLESHOOTING

| Problem | First Check |
|---|---|
| AI DM not responding | Groq API key expired â†’ Renew at console.groq.com |
| Voice not playing | ElevenLabs model string â†’ Must be `eleven_turbo_v2_5` |
| Frontend can't reach backend | Railway service running? CORS config correct? |
| React rendering error | Check for object-as-child (render `.name`, `.text` not whole object) |
| State not updating | Zustand selector â€” use shallow equality, check store action |
| Deploy not reflecting changes | Vercel â€” manual redeploy required after push |
| Status effects not showing | Check `character.statusEffects` array in store is populated |

---

*This document represents the complete state of the AI Dungeon Master project as of February 2026. All listed features are confirmed working in production unless marked âŒ.*