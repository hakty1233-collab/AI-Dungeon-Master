# AI Dungeon Master - Project Context & State

## ğŸ® Project Overview
A fully-featured AI Dungeon Master for D&D 5e with voice narration, combat system, character progression, and save/load functionality.

---

## ğŸ—ï¸ Tech Stack
- **Frontend**: React (Create React App)
- **Backend**: Node.js + Express
- **AI Models**: 
  - Groq API (Llama 3.3 70B) for DM narration
  - ElevenLabs API for voice synthesis (model: `eleven_turbo_v2_5`)
- **State Management**: Zustand
- **Routing**: React Router

---

## ğŸ“ Project Structure

```
AI-Dungeon-Master/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ dm/
â”‚   â”‚   â”‚   â”œâ”€â”€ dmEngine.js (DM AI logic, Groq integration)
â”‚   â”‚   â”‚   â””â”€â”€ systemPrompt.js
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ campaign.js (POST /start-campaign)
â”‚   â”‚   â”‚   â”œâ”€â”€ turn.js (POST /turn)
â”‚   â”‚   â”‚   â”œâ”€â”€ voice.js (POST /voice - ElevenLabs)
â”‚   â”‚   â”‚   â””â”€â”€ soundEffects.js (POST /sound-effects)
â”‚   â”‚   â””â”€â”€ index.js (Express server on port 3001)
â”‚   â””â”€â”€ .env (ElevenLabs API key)
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ GameScreen.jsx (main game UI)
â”‚   â”‚   â”‚   â”œâ”€â”€ DMSetup.jsx (campaign setup)
â”‚   â”‚   â”‚   â”œâ”€â”€ CharacterCreator.jsx (4-step character wizard)
â”‚   â”‚   â”‚   â”œâ”€â”€ CharacterSheet.jsx (full D&D character sheet)
â”‚   â”‚   â”‚   â”œâ”€â”€ CombatTracker.jsx (turn-based combat UI)
â”‚   â”‚   â”‚   â”œâ”€â”€ StartCombatModal.jsx (enemy selection)
â”‚   â”‚   â”‚   â”œâ”€â”€ SaveLoadModal.jsx (save/load campaigns)
â”‚   â”‚   â”‚   â”œâ”€â”€ LevelUpNotification.jsx (level-up animation)
â”‚   â”‚   â”‚   â”œâ”€â”€ XPNotification.jsx (XP toast)
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatLog.jsx (adventure log)
â”‚   â”‚   â”‚   â””â”€â”€ DiceRoller.jsx (dice rolling UI)
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ characterSystem.js (D&D 5e character mechanics)
â”‚   â”‚   â”‚   â”œâ”€â”€ combatSystem.js (initiative, attacks, damage)
â”‚   â”‚   â”‚   â”œâ”€â”€ xpSystem.js (XP detection & awarding)
â”‚   â”‚   â”‚   â””â”€â”€ narrativeParser.js (dialogue/voice detection)
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.js (backend API calls)
â”‚   â”‚   â”‚   â”œâ”€â”€ voiceApi.js (ElevenLabs voice)
â”‚   â”‚   â”‚   â”œâ”€â”€ soundEffectsApi.js (ElevenLabs SFX)
â”‚   â”‚   â”‚   â””â”€â”€ saveLoadService.js (localStorage save/load)
â”‚   â”‚   â”œâ”€â”€ state/
â”‚   â”‚   â”‚   â””â”€â”€ campaignStore.js (Zustand global state)
â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚       â””â”€â”€ global.css (unified theme - NEEDS TO BE CREATED)
â””â”€â”€ launcher.bat (Windows launcher)
```

---

## âœ… Completed Features

### **Core Systems**
1. âœ… **Campaign Management**
   - Theme and difficulty selection
   - Party creation and management
   - Campaign state persistence

2. âœ… **Character System (Full D&D 5e)**
   - 12 classes (Barbarian, Bard, Cleric, Druid, Fighter, Monk, Paladin, Ranger, Rogue, Sorcerer, Warlock, Wizard)
   - 9 races (Human, Elf, Dwarf, Halfling, Dragonborn, Gnome, Half-Elf, Half-Orc, Tiefling)
   - Point-buy ability score system (27 points)
   - Full character sheets with stats, skills, saves
   - Character creator wizard (4 steps)

3. âœ… **XP & Leveling System**
   - Automatic XP detection from narration
   - XP awards for: combat (25-5900 XP), puzzles (50 XP), quests (150 XP), discoveries (100 XP)
   - Automatic level-up with HP increases
   - Epic level-up animation with sparkles
   - XP toast notifications

4. âœ… **Combat System**
   - Initiative tracking with automatic rolls
   - Turn-based combat flow
   - Enemy templates (Goblin, Skeleton, Orc, Bugbear, Ogre, Troll, Young Dragon)
   - Attack rolls (d20 + bonus vs AC)
   - Damage rolls with critical hits (natural 20)
   - Fumbles (natural 1)
   - Auto enemy AI turns
   - Combat log
   - XP rewards on victory

5. âœ… **Voice & Audio**
   - ElevenLabs voice narration with multiple voices:
     - narrator (Rachel - default)
     - gruff (Josh - warriors)
     - old_wise (Bella - elders)
     - young (Elli - children)
     - dark (Domi - villains)
   - Dynamic character voice selection based on description
   - Narrative parsing for dialogue
   - Sound effect detection (birds, wind, combat, etc.)
   - Background sound effects during narration

6. âœ… **Save/Load System**
   - Multiple save slots
   - Auto-save after each turn
   - Save metadata (timestamp, play time, preview)
   - Export/import saves as JSON
   - Delete saves

7. âœ… **Dice Rolling**
   - d4, d6, d8, d10, d12, d20
   - Visual feedback
   - Integration with combat

---

## ğŸ”‘ API Keys & Configuration

### Backend (.env)
```
ELEVENLABS_API_KEY=sk_8b508aa9cf4346db31a259ad9bc5bce9dfe18f0b9342f223
```

### APIs Used
1. **Groq API** (in dmEngine.js)
   - API Key: `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`
   - Model: `llama-3.3-70b-versatile`
   - Base URL: `https://api.groq.com/openai/v1`

2. **ElevenLabs API**
   - Voice Model: `eleven_turbo_v2_5` (free tier)
   - âš ï¸ OLD MODEL `eleven_monolingual_v1` is deprecated

---

## ğŸ¨ Current UI State

### **Working But Needs Unification:**
- âœ… GameScreen - partially updated
- âš ï¸ CombatTracker - functional but styling inconsistent
- âš ï¸ StartCombatModal - functional but needs polish
- âš ï¸ CharacterSheet - functional but could be prettier
- âš ï¸ CharacterCreator - functional but styling could match
- âš ï¸ SaveLoadModal - functional but needs theme update
- âš ï¸ DMSetup - needs significant styling update

### **Theme Created But Not Applied:**
- Created `global.css` with unified dark fantasy theme
- Gold (#ffd700) primary color
- Dark red (#d32f2f) for combat/danger
- Dark backgrounds (#0a0a0a, #1a1a1a, #2a2a2a)
- Consistent card, button, input styles
- Smooth animations and transitions

---

## ğŸ› Known Issues & Quirks

1. **Browser Speech Recognition**
   - Disabled because it's unreliable across browsers
   - Was causing infinite loop issues
   - Left as disabled button in UI

2. **State Variable Patterns**
   - React useState declarations sometimes don't apply from artifacts
   - Need to manually add state variables then hard refresh
   - Example: `const [combat, setCombat] = useState(null);`

3. **Zustand Store Pattern**
   - Must extract store functions individually: `const func = useStore(state => state.func)`
   - Can't destructure multiple at once reliably

4. **Sound Effects**
   - ElevenLabs sound generation API works but uses quota
   - Currently generates max 2 sound effects per narration
   - Plays at 30% volume as background ambient

---

## ğŸš€ Immediate Next Steps

### **Phase 1: UI Unification** (30-60 min)
1. Create `frontend/src/styles/global.css`
2. Import in `frontend/src/index.js`
3. Update components to use unified classes:
   - CombatTracker.jsx
   - StartCombatModal.jsx
   - CharacterSheet.jsx
   - CharacterCreator.jsx
   - SaveLoadModal.jsx
   - DMSetup.jsx

### **Phase 2: Choose Next Feature**
Options (in priority order):
1. **Background Music** ğŸµ - Easy, huge impact
2. **Inventory System** ğŸ’ - Medium, core RPG feature
3. **Quest System** ğŸ“œ - Medium, adds structure
4. **Map System** ğŸ—ºï¸ - Medium-Hard, exploration depth

---

## ğŸ“ Important Code Patterns

### **Adding State to GameScreen:**
```javascript
// Always declare at top of component
const [stateName, setStateName] = useState(initialValue);

// Extract from store individually
const storeFunc = useCampaignStore(state => state.storeFunc);
```

### **XP Detection Keywords:**
Combat: defeated, slain, killed, vanquished, destroyed, battle won, victory, triumph
Puzzles: solved, unlocked, discovered the solution
Quests: quest complete, mission accomplished, task finished

### **Voice Selection:**
- Detects keywords in narration: "gravelly", "old", "young", "dark", "sinister"
- Maps to ElevenLabs voice IDs
- Parses dialogue from quotes in narration

### **Combat Flow:**
1. StartCombatModal â†’ select enemies â†’ create combat state
2. CombatTracker displays â†’ roll initiative â†’ sort turn order
3. Player turn â†’ select target â†’ click attack â†’ roll attack/damage
4. Auto enemy turns â†’ AI selects random alive party member
5. Check for victory/defeat â†’ award XP

---

## ğŸ¯ Key User Workflows

### **Starting a Campaign:**
1. DMSetup â†’ Set theme/difficulty
2. Click "Create Character" â†’ 4-step wizard
3. Add multiple characters
4. Click "Begin Adventure"
5. GameScreen loads with first DM narration

### **Playing the Game:**
1. Type action or use voice input
2. DM responds with narration
3. Voice narration plays automatically
4. XP awarded if keywords detected
5. Level-up animation if threshold reached
6. Auto-save after each turn

### **Combat:**
1. Click "Start Combat" button
2. Select enemies from templates
3. Set count for each enemy type
4. Initiative rolled automatically
5. Take turns attacking enemies
6. Auto enemy turns
7. Victory â†’ XP award â†’ level-up check

---

## ğŸ”§ Running the Project

### **Start Backend:**
```bash
cd backend
node src/index.js
```
Server runs on `http://localhost:3001`

### **Start Frontend:**
```bash
cd frontend
npm start
```
App runs on `http://localhost:3000`

### **Or Use Launcher (Windows):**
```bash
launcher.bat
```

---

## ğŸ’¡ Design Philosophy

- **Dark Fantasy Theme**: Gold accents, dark backgrounds, atmospheric
- **Immersive Audio**: Voice narration with character voices, ambient sounds
- **Automatic Systems**: XP detection, auto-save, AI enemy turns
- **D&D 5e Accurate**: Real rules, proper dice mechanics, official classes/races
- **User-Friendly**: Clear feedback, animations, tooltips, error handling

---

## ğŸ“Š Current Status Summary

**What Works Perfectly:**
- âœ… Campaign creation and management
- âœ… Character creation with full D&D 5e rules
- âœ… XP and leveling with animations
- âœ… Combat system with initiative and AI
- âœ… Voice narration with dynamic voices
- âœ… Save/load system
- âœ… Dice rolling

**What Needs Polish:**
- âš ï¸ UI consistency (theme exists but not applied everywhere)
- âš ï¸ Some components need styling updates
- âš ï¸ Could use more visual feedback in places

**What Could Be Added:**
- ğŸ”² Inventory system
- ğŸ”² Background music
- ğŸ”² Quest system
- ğŸ”² Map/exploration system
- ğŸ”² More enemy types
- ğŸ”² Spell system
- ğŸ”² Status effects

---

## ğŸ¨ Theme Reference

```css
Primary: #ffd700 (gold)
Danger: #d32f2f (dark red)
Success: #4CAF50 (green)
Info: #2196F3 (blue)
Warning: #ff9800 (orange)

BG Primary: #0a0a0a
BG Secondary: #1a1a1a
BG Tertiary: #2a2a2a

Text Primary: #eee
Text Secondary: #aaa
Text Tertiary: #888

Border: #444
Border Active: #ffd700
```

---

## ğŸš¨ Critical Reminders for Next Session

1. **Always manually add useState declarations** - artifacts don't reliably apply them
2. **ElevenLabs model is `eleven_turbo_v2_5`** - not the old monolingual one
3. **Extract Zustand functions individually** - don't destructure from store
4. **XP system is working** - detects from narration keywords
5. **Combat system is complete** - just needs UI polish
6. **Global CSS created but not imported yet** - this is the immediate next step

---

## ğŸ“ Quick Reference

**Backend Port:** 3001
**Frontend Port:** 3000
**Main Entry:** `frontend/src/App.jsx` â†’ routes to DMSetup or GameScreen
**State Store:** `frontend/src/state/campaignStore.js`
**DM AI:** `backend/src/dm/dmEngine.js`

---

## âœ¨ What Makes This Project Special

1. **Real D&D 5e mechanics** - not simplified
2. **Professional voice acting** via ElevenLabs
3. **Smart XP detection** - no manual tracking
4. **Full combat system** - initiative, turns, AI enemies
5. **Character progression** - level 1-20 with all features
6. **Epic animations** - level-ups, XP gains, dice rolls
7. **Save anywhere** - never lose progress
8. **Multiple party members** - full party management

This is a professional-quality AI DM that rivals commercial RPG experiences! ğŸ®âœ¨

---

*Last Updated: Current conversation*
*Next Priority: Apply global.css theme to all components*